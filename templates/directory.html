{% extends "base.html" %}
{% block title %}Recycler Directory - EcoScan{% endblock %}

{% block content %}
<section class="directory-section max-w-6xl mx-auto p-8 bg-white shadow-xl rounded-lg">
  <h1 class="text-4xl font-bold text-text-dark mb-2 text-center">Recycling Center Directory</h1>
  <p class="subtitle text-text-light mb-8 text-center">
    Find local recycling facilities and drop-off points near you.
  </p>

  <!-- Filters -->
  <div class="directory-filters flex flex-wrap justify-center gap-4 mb-6">
    <label class="font-semibold">
      Waste Type:
      <select id="filterType" onchange="filterRecyclers()" class="p-2 border rounded">
        <option value="">All Types</option>
        <option value="plastic">Plastic</option>
        <option value="glass">Glass</option>
        <option value="metal">Metal</option>
        <option value="paper">Paper</option>
        <option value="cardboard">Cardboard</option>
        <option value="trash">Non-Recyclable/Other</option>
      </select>
    </label>
    <label class="font-semibold">
      City/Location:
      <input type="text" id="filterCity" oninput="filterRecyclers()" placeholder="E.g., Mumbai, Delhi"
        class="p-2 border rounded">
    </label>
  </div>

  <!-- Map + List -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
    <div class="lg:col-span-2">
      <h2 class="text-2xl font-semibold mb-3">Map View</h2>
      <div id="map" class="w-full h-[500px] bg-gray-200 rounded-lg shadow-inner"></div>
    </div>

    <div class="lg:col-span-1">
      <h2 class="text-2xl font-semibold mb-3">Locations List</h2>
      <ul id="recyclerList"
        class="directory-list bg-neutral p-4 rounded-lg shadow-inner max-h-[500px] overflow-y-auto space-y-3">
        <li class="p-3 bg-white border-b">Loading locations...</li>
      </ul>
    </div>
  </div>

  <hr class="my-10">

  

  <!-- Recent Collections -->
  <h2 class="text-2xl font-bold text-center mb-4">Recent Collections</h2>
  <div class="overflow-x-auto">
    <table class="table table-bordered text-center w-full">
      <thead class="bg-green-700 text-white">
        <tr>
          <th>Image</th>
          <th>Material</th>
          <th>Description</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="collectionsBody">
        <tr><td colspan="5" class="py-3 italic">Loading collections...</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- âœ… Modal Popup for Company Details -->
<div class="modal-backdrop" id="infoModal" style="
  display: none; 
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 9999;">
  <div style="
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: fadeIn 0.3s ease;">
    <h4 class="text-success fw-bold mb-3">Collection Details</h4>
    <p><strong>Company Name:</strong> <span id="modalCompanyName"></span></p>
    <p><strong>Status:</strong> <span id="modalStatus"></span></p>
    <p><strong>About Company:</strong></p>
    <div id="modalCompanyInfo" class="bg-light p-2 rounded border mt-1"></div>
    <div class="text-end mt-4">
      <button id="closeModal" class="btn btn-secondary btn-sm">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/directory.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const body = document.getElementById("collectionsBody");
  try {
    const res = await fetch("/get_uploads");
    const data = await res.json();
    if (data.success && data.uploads.length > 0) {
      body.innerHTML = "";
      data.uploads.forEach(u => {
        if (u.status === "Collected") {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><img src="${u.image_path}" width="70" height="70" class="rounded"/></td>
            <td>${u.label || "N/A"}</td>
            <td>${u.description || "No description"}</td>
            <td>${u.created_at}</td>
            <td><button class="btn btn-primary btn-sm" onclick="showDetails('${u.collected_by || ''}', '${u.status || ''}', \`${u.company_info || ''}\`)">View</button></td>
          `;
          body.appendChild(row);
        }
      });
      if (body.innerHTML.trim() === "") {
        body.innerHTML = `<tr><td colspan="5" class="italic">No collections yet.</td></tr>`;
      }
    } else {
      body.innerHTML = `<tr><td colspan="5" class="italic">No data found.</td></tr>`;
    }
  } catch (err) {
    console.error(err);
    body.innerHTML = `<tr><td colspan="5" class="text-danger">Error loading data.</td></tr>`;
  }
});

function showDetails(company, status, info) {
  document.getElementById("modalCompanyName").textContent = company || "N/A";
  document.getElementById("modalStatus").textContent = status || "Pending";
  document.getElementById("modalCompanyInfo").textContent = info || "No details available.";
  document.getElementById("infoModal").style.display = "flex";
}

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("infoModal").style.display = "none";
});
</script>
{% endblock %}
