{% extends "base.html" %}

{% block title %}Classify Waste{% endblock %}

{% block head_links %}
<!-- Custom styles to enhance the drop zone appearance (using CSS for self-contained style) -->
<style>
    .upload-area {
        transition: all 0.3s ease;
        border: 4px dashed #9ca3af; /* Default gray border */
    }
    .upload-area:hover, .upload-area.drag-over {
        border-color: #10b981; /* Green border on hover/drag */
        background-color: #f0fdf4; /* Light green background */
        box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1), 0 4px 6px -2px rgba(16, 185, 129, 0.05);
    }
    .scanning-status {
        transition: opacity 0.3s ease;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .upload-icon-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .upload-recycle-icon {
        position: absolute;
        bottom: 0;
        right: 0;
        transform: translate(25%, 25%);
        font-size: 1.5rem;
        color: #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8"> 
    <main class="text-center"> 
        <h1 class="text-4xl font-extrabold text-gray-900">Classify Your Waste</h1>
        <p class="mt-3 text-lg text-gray-600">Upload a clear photo for instant classification and recycling guidance.</p>

        <div class="mt-10 space-y-6">

            <!-- Upload Area (Drag and Drop Zone) -->
            <div class="upload-area flex flex-col items-center justify-center p-12 rounded-2xl bg-gray-50 text-gray-500 w-full h-80" id="uploadArea">
                
                <div class="upload-icon-container mb-4">
                    <i class="fas fa-camera text-6xl text-gray-400"></i>
                    <i class="fas fa-recycle upload-recycle-icon text-green-500"></i>
                </div>
                
                <p class="drag-drop-text text-xl font-semibold">Drag & Drop your photo here</p>
                <p class="or-separator my-2 text-sm text-gray-400">OR</p>
                
                <button class="snap-classify-btn px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105" id="triggerFileInput">
                    <i class="fas fa-image mr-2"></i> SNAP & CLASSIFY
                </button>
                
                <!-- Hidden file input for capturing image/file -->
                <input type="file" id="wasteImage" name="wasteImage" accept="image/png, image/jpeg, image/jpg, image/gif" capture="camera" hidden>
            </div>

            <!-- Feedback Area -->
            <div class="feedback-area min-h-[4rem]">
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="scanning-status flex items-center justify-center space-x-3 text-xl font-semibold text-green-600 bg-green-50 p-4 rounded-lg shadow-md" style="display: none;">
                    <i class="fas fa-lightbulb"></i> <span>Scanning... Please wait.</span>
                </div>
                
                <!-- Result/Error Box -->
                <div id="resultBox" class="flex items-center justify-center space-x-3 text-xl font-semibold p-4 rounded-lg shadow-md" style="display: none;">
                    <i class="fas fa-exclamation-triangle text-red-500"></i> 
                    <span id="resultMessageContent" class="text-red-700"></span>
                </div>
            </div>
            
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get all necessary elements once
    const wasteImageInput = document.getElementById('wasteImage');
    const triggerFileInput = document.getElementById('triggerFileInput');
    const uploadArea = document.getElementById('uploadArea');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultBox = document.getElementById('resultBox');
    const resultMessageContent = document.getElementById('resultMessageContent');

    // Helper function to show a custom error message (replaces alert())
    function showFeedback(message, isError = false) {
        loadingIndicator.style.display = 'none';
        resultBox.style.display = 'flex';
        
        if (isError) {
            resultBox.className = 'flex items-center justify-center space-x-3 text-xl font-semibold p-4 rounded-lg shadow-md bg-red-100 border border-red-200';
            resultMessageContent.className = 'text-red-700';
            resultMessageContent.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
        } else {
            resultBox.className = 'flex items-center space-x-3 text-xl font-semibold p-4 rounded-lg shadow-md bg-green-100 border border-green-200';
            resultMessageContent.className = 'text-green-700';
            resultMessageContent.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        }
        uploadArea.style.display = 'flex'; // Re-enable upload area on error
    }

    // Main file upload logic with exponential backoff
    function processUpload(file) {
        if (!file) return;

        // Step 1: Provide immediate feedback
        uploadArea.style.display = 'none'; 
        resultBox.style.display = 'none';
        loadingIndicator.style.display = 'flex'; // Show scanning status

        const formData = new FormData();
        formData.append('wasteImage', file);
        
        const maxRetries = 3;
        const initialDelay = 1000; // 1 second

        function attemptFetch(retryCount) {
            fetch('{{ url_for("upload_file") }}', { 
                method: 'POST',
                body: formData,
            })
            .then(response => {
                // If unauthorized (e.g., session expired), redirect to login
                if (response.status === 401) {
                    window.location.href = '{{ url_for("login") }}';
                    return; 
                }
                if (!response.ok) {
                    return response.json().then(data => Promise.reject(data));
                }
                return response.json();
            })
            .then(data => {
                loadingIndicator.style.display = 'none'; 
                
                if (data.success) {
                    // CRITICAL: Redirect to results page on success
                    console.log("Upload successful. Redirecting to results page.");
                    window.location.href = '{{ url_for("results_page") }}';
                } else {
                    const errorMessage = data.error || 'Server rejected file (check type/size).';
                    showFeedback(`Error: ${errorMessage}`, true);
                }
            })
            .catch(error => {
                console.error('Upload Failed:', error);
                // Extract error message from the rejected promise structure
                const errorMessage = error.error || 'Network connection failed.';

                if (retryCount < maxRetries) {
                    const delay = initialDelay * Math.pow(2, retryCount);
                    // Do not log retry attempts as errors in the console
                    setTimeout(() => attemptFetch(retryCount + 1), delay);
                } else {
                    showFeedback(`Fatal Error after ${maxRetries} attempts: ${errorMessage}`, true);
                }
            });
        }
        
        attemptFetch(0);
    }

    // 1. Link the visible button to the hidden file input
    triggerFileInput.addEventListener('click', function() {
        wasteImageInput.click();
    });

    // 2. Handle file selection
    wasteImageInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
            processUpload(event.target.files[0]);
            event.target.value = ''; // Reset input so the same file can be uploaded again
        }
    });

    // 3. Implement Drag & Drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault(); 
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            if (file.type.startsWith('image/')) {
                processUpload(file);
            } else {
                // Use custom feedback instead of alert()
                showFeedback("Please drop a valid image file (PNG, JPG, JPEG, GIF).", true);
            }
        }
    });
</script>
{% endblock %}
